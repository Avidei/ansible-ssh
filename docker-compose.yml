services:
  ansible:
    image: avidei/ansible-ssh:latest
    ports:
      - "2222:22"
    volumes:
      - /mnt/nfs-shares/ansible/ansible:/home/avidei/.ansible
      - /mnt/nfs-shares/ansible/ssh:/home/avidei/.ssh
    environment:
      ANSIBLE_DIR: /home/avidei/.ansible
      
    command:
      [      
        "/bin/bash",
        "-c",
        "set -e && 

        mkdir -p $$ANSIBLE_DIR/{inventory,playbooks,roles,files,templates} &&
        if [ ! -f $$ANSIBLE_DIR/ansible.cfg ]; then
          echo '[defaults]' > $$ANSIBLE_DIR/ansible.cfg &&
          echo 'inventory = ./inventory/hosts.yml' >> $$ANSIBLE_DIR/ansible.cfg &&
          echo 'roles_path = ./roles' >> $$ANSIBLE_DIR/ansible.cfg &&
          echo 'host_key_checking = False' >> $$ANSIBLE_DIR/ansible.cfg &&
          echo 'interpreter_python = auto_silent' >> $$ANSIBLE_DIR/ansible.cfg &&
          echo 'deprecation_warnings = False' >> $$ANSIBLE_DIR/ansible.cfg;
        fi &&
        if [ ! -f $$ANSIBLE_DIR/inventory/hosts.yml ]; then
          touch $$ANSIBLE_DIR/inventory/hosts.yml;
        fi &&
        chown -R 1000:1000 /home/avidei/.ansible &&
        echo 'âœ… Ansible environment ready' &&
        rsyslogd &&
        /usr/sbin/sshd -D",
      ]
    restart: unless-stopped
